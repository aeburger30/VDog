<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Vinyl Scout</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        /* APP STYLING */
        body { max-width: 800px; margin: 0 auto; padding: 15px; background: #111; }
        
        /* 1. SETUP BOX (Shown on first load) */
        #settings-box { 
            background: #222; padding: 25px; border-radius: 8px; margin-top: 20px; border: 1px solid #444; 
        }
        input[type="password"] { background: #000; border-color: #333; }
        
        /* 2. CAMERA VIEW */
        .camera-container { 
            position: relative; width: 100%; height: 350px; background: #000; 
            border-radius: 8px; overflow: hidden; margin-bottom: 20px; 
            display: flex; align-items: center; justify-content: center;
            border: 2px solid #333;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* 3. CONTROLS */
        .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        button { padding: 12px; font-weight: bold; }
        
        /* 4. GALLERY RESULTS */
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; }
        .gallery-item { background: #1a1a1a; padding: 10px; border-radius: 8px; border: 1px solid #333; }
        .gallery-item img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 4px; margin-bottom: 10px;}
        
        .info { font-size: 0.8em; line-height: 1.4em; }
        .info strong { color: #4dabf5; display: block; font-size: 1.1em; margin-bottom: 2px; }
        .info em { color: #ccc; font-style: normal; display: block; margin-bottom: 5px; }
        
        /* Status Badges */
        .status-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.7em; margin-bottom: 8px; text-transform: uppercase; font-weight: bold;}
        .bdg-pending { background: #333; color: #888; }
        .bdg-done { background: #1b5e20; color: #a5d6a7; }
        .bdg-error { background: #b71c1c; color: #ffcdd2; }

        /* Links */
        .discogs-btn { 
            display: block; width: 100%; text-align: center; padding: 8px 0; 
            margin-top: 8px; background: #fbc02d; color: #000; text-decoration: none; 
            border-radius: 4px; font-weight: bold; font-size: 0.85em;
            transition: opacity 0.2s;
        }
        .discogs-btn:active { opacity: 0.7; }
    </style>
</head>
<body>

    <nav>
        <ul><li><strong>Vinyl Scout</strong></li></ul>
        <ul><li><a href="#" class="secondary" onclick="clearKeys()" style="font-size:0.8em">Reset Keys</a></li></ul>
    </nav>

    <div id="settings-box">
        <h4 style="margin-bottom:10px;">üîê App Setup</h4>
        <p style="font-size:0.8em; color:#888; margin-bottom:20px;">
            Your API keys are stored securely on your phone/computer. They are never sent to any server other than Google/Discogs.
        </p>
        <label for="input-gemini">Gemini API Key</label>
        <input type="password" id="input-gemini" placeholder="AIzaSy...">
        
        <label for="input-discogs">Discogs Token</label>
        <input type="password" id="input-discogs" placeholder="abc12345...">
        
        <button onclick="saveKeys()" style="margin-top:10px;">Save & Launch App</button>
    </div>

    <div id="app-interface" style="display:none;">
        
        <div class="camera-container">
            <video id="camera-feed" autoplay playsinline muted></video>
        </div>

        <div class="grid">
            <button onclick="takePhoto()">üì∏ Snap</button>
            <button class="secondary" onclick="document.getElementById('file-input').click()">üìÇ Upload</button>
            <button class="contrast" id="process-btn" onclick="processBatch()">üöÄ Process</button>
        </div>
        <input type="file" id="file-input" multiple accept="image/*" onchange="handleFiles(this.files)" style="display:none;">

        <details open>
            <summary>Scanned Records (<span id="count">0</span>)</summary>
            <div id="gallery" class="gallery"></div>
        </details>
        
        <div style="margin-top:20px; border-top:1px solid #333; padding-top:10px;">
            <small style="color:#666">System Logs:</small>
            <pre id="logs" style="height: 80px; overflow-y: scroll; font-size: 0.7em; background: #000; padding: 5px; color:#0f0; border:1px solid #333;">System Ready...</pre>
        </div>
    </div>

    <script>
        // GLOBALS
        let GEMINI_KEY = localStorage.getItem('v_gemini_key');
        let DISCOGS_KEY = localStorage.getItem('v_discogs_key');
        let photoStack = [];

        // 1. INIT: CHECK FOR KEYS
        function checkKeys() {
            if (GEMINI_KEY && DISCOGS_KEY) {
                document.getElementById('settings-box').style.display = 'none';
                document.getElementById('app-interface').style.display = 'block';
                startCamera();
            }
        }

        function saveKeys() {
            const g = document.getElementById('input-gemini').value.trim();
            const d = document.getElementById('input-discogs').value.trim();
            if(!g || !d) return alert("Both keys are required to function.");
            
            localStorage.setItem('v_gemini_key', g);
            localStorage.setItem('v_discogs_key', d);
            location.reload(); 
        }

        function clearKeys() {
            if(confirm("Forget API keys and reset app?")) {
                localStorage.clear();
                location.reload();
            }
        }

        // 2. CAMERA LOGIC
        async function startCamera() {
            try {
                // 'environment' requests the back camera on phones
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                document.getElementById('camera-feed').srcObject = stream;
            } catch (e) {
                log("Camera access failed. (This is normal on laptops without HTTPS, or if blocked). Upload mode is active.");
            }
        }

        function takePhoto() {
            const video = document.getElementById('camera-feed');
            if (!video.srcObject) return alert("Camera not active. Use Upload button.");
            
            const canvas = document.createElement('canvas');
            // Resize to 800px width for optimal AI speed
            const scale = 800 / video.videoWidth;
            canvas.width = 800;
            canvas.height = video.videoHeight * scale;
            
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            addPhoto(canvas.toDataURL('image/jpeg', 0.7));
        }

        function handleFiles(files) {
            log(`Processing ${files.length} uploads...`);
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scale = 800 / img.width;
                        canvas.width = 800;
                        canvas.height = img.height * scale;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        addPhoto(canvas.toDataURL('image/jpeg', 0.7));
                    }
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function addPhoto(data) {
            photoStack.push({ id: Date.now() + Math.random(), data: data, status: 'pending', result: null });
            renderGallery();
        }

        // 3. PROCESSING LOGIC
        async function processBatch() {
            const btn = document.getElementById('process-btn');
            btn.setAttribute('aria-busy', 'true');
            btn.innerText = "Scanning...";
            
            for(let i=0; i<photoStack.length; i++) {
                let item = photoStack[i];
                if(item.status === 'done') continue;

                log(`Analyzing item ${i+1}...`);
                
                try {
                    // A. Call Gemini
                    const base64 = item.data.split(',')[1];
                    const gRes = await callGemini(base64);
                    log(`Found: ${gRes.artist}`);
                    
                    item.result = gRes; 
                    renderGallery();

                    // B. Call Discogs (Safe Mode)
                    const dRes = await callDiscogs(gRes);
                    item.result = { ...gRes, ...dRes };
                    item.status = 'done';

                } catch (e) {
                    log("Error: " + e.message);
                    item.status = 'error';
                }
                renderGallery();
            }
            btn.setAttribute('aria-busy', 'false');
            btn.innerText = "Start New Batch";
        }

        async function callGemini(base64) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_KEY}`;
            const payload = {
                contents: [{ parts: [
                    { text: "Return strictly JSON: { \"artist\": \"Name\", \"album\": \"Title\", \"year\": \"19XX\", \"cat_num\": \"Number\" }" },
                    { inline_data: { mime_type: "image/jpeg", data: base64 } }
                ]}]
            };
            
            const res = await fetch(url, { method: 'POST', body: JSON.stringify(payload) });
            if(!res.ok) throw new Error(`Gemini API Error: ${res.status}`);
            
            const data = await res.json();
            let text = data.candidates[0].content.parts[0].text;
            // Clean Markdown
            text = text.replace(/```json|```/g, '').trim();
            return JSON.parse(text);
        }

        async function callDiscogs(data) {
            let q = `${data.artist} ${data.album} ${data.cat_num || ''}`;
            const manualUrl = `https://www.discogs.com/search/?q=${encodeURIComponent(q)}&type=release`;
            
            try {
                // 2.5s Timeout to prevent freezing
                const controller = new AbortController();
                setTimeout(() => controller.abort(), 2500);
                
                const res = await fetch(`https://api.discogs.com/database/search?q=${encodeURIComponent(q)}&token=${DISCOGS_KEY}`, {
                    signal: controller.signal
                });
                
                if(!res.ok) throw new Error("Blocked");
                const json = await res.json();
                
                if(json.results?.[0]) {
                    return { 
                        url: `https://www.discogs.com${json.results[0].uri}`,
                        success: true 
                    };
                }
            } catch(e) { 
                // Fallback to manual link silently
            }
            
            return { url: manualUrl, success: false };
        }

        // 4. UI RENDERER
        function renderGallery() {
            const el = document.getElementById('gallery');
            el.innerHTML = '';
            document.getElementById('count').innerText = photoStack.length;

            photoStack.slice().reverse().forEach(item => {
                let badgeClass = item.status === 'pending' ? 'bdg-pending' : (item.status === 'done' ? 'bdg-done' : 'bdg-error');
                
                let html = `<div class="gallery-item">
                    <img src="${item.data}">
                    <div class="info">
                        <span class="status-badge ${badgeClass}">${item.status}</span>`;
                
                if(item.result) {
                    html += `<strong>${item.result.artist || 'Unknown'}</strong>
                             <em>${item.result.album || 'Unknown'}</em>
                             <div style="color:#666; font-size:0.9em;">
                                ${item.result.year || '?'} ‚Ä¢ ${item.result.cat_num || 'No Cat#'}
                             </div>`;
                    
                    if(item.result.url) {
                        let color = item.result.success ? '#fbc02d' : '#e0e0e0';
                        let text = item.result.success ? 'View Price / Details' : 'Manual Search';
                        html += `<a href="${item.result.url}" target="_blank" class="discogs-btn" style="background:${color}">
                                    ${text}
                                 </a>`;
                    }
                }
                html += `</div></div>`;
                el.innerHTML += html;
            });
        }

        function log(m) { 
            const l = document.getElementById('logs');
            l.innerText += '\n> ' + m; 
            l.scrollTop = l.scrollHeight;
        }

        // BOOT
        checkKeys();
    </script>
</body>
</html>
